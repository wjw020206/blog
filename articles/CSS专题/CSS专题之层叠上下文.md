# CSS专题之层叠上下文



## 前言

> 石匠敲击石头的第 15 次

在平常开发的时候，有时候会遇到使用 `z-index` 调整元素层级没有效果的情况，究其原因还是因为对层叠上下文不太了解，看了网上很多前辈的文章，决定打算写一篇文章来梳理一下，如果哪里写的有问题欢迎指出，不胜感激。



## 什么是层叠上下文

层叠上下文（**Stacking Context**）是 HTML 中的三维概念，它决定了元素在 **Z 轴（垂直于电脑屏幕的方向）**上的显示顺序。简单来说，**层叠上下文是浏览器用来组织元素 Z 轴方向堆叠顺序的一个独立的 “视觉区域” 或 “作用域”**。

![image-20250525130425840](images/image-20250525130425840.png)

层叠上下文的概念有点类似于块级格式化上下文（BFC），都是在特定条件下由元素创建的独立作用区域，并且区域内遵循各自的规则，**但它作用在视觉层级（`z-index`）而非布局流**。



## 什么是层叠水平

在一个层叠上下文中，**层叠水平（Stacking Level，也叫层叠等级）** 用于确定其**子元素**在 Z 轴方向上的显示优先级，简单来说，**层叠水平决定了同一层叠上下文内的元素谁在上、谁在下**。

**⚠️ 注意：** 

- **元素的层叠水平是由其所属的层叠上下文来决定的**，也就是说**层叠水平的比较只有在同一个层叠上下文中才有意义**，所以不同层叠上下文之间的元素不会互相影响
- 某些情况下（Flex 子元素和定位元素） `z-index` 确实可以影响元素的层叠水平，但层叠水平**不等于** `z-index`，**所有元素都有层叠水平**



##  什么是层叠顺序

层叠上下文和层叠顺序这两个终究只是抽象的概念，但元素具体是按照什么规则层叠的，这就不得不提**层叠顺序（Stacking Order）**。

简单来说，层叠顺序就是指当多个元素在 Z 轴方向发生**重叠**时，**浏览器决定哪些元素显示在上、哪些元素被遮挡**的一套规则。

![image-20250527073255399](images/image-20250527073255399.png)

上图展示了在**不考虑 CSS3  新特性（如 `flex`、`grid`、`isolation` 等）的前提下**，浏览器在同一层叠上下文中渲染元素的顺序，从下往上堆叠。

**⚠️ 注意：**

- 左上角的层叠上下文 ` background` / `border` 是指层叠上下文元素的边框和背景颜色，是最低的层叠等级

- `inline` 和 `inline-block` 元素是相同的层叠等级，**并且要高于 `block` 和 `float` 元素**

- 之所以文字相关元素（通常是 `inline`）层级更高，是出于网页设计初衷：**优先保障文字可见性**，避免被大面积背景或容器遮挡

- `z-index: 0` 和 `z-index: auto` **从层叠等级上看相同的，但实际上两个属性值有着根本的区别**，具体区别可以看下表

  | 属性值          | 是否创建层叠上下文                           | 说明                                                         |
  | --------------- | -------------------------------------------- | ------------------------------------------------------------ |
  | `z-index: auto` | **不会**创建新的层叠上下文                   | 元素仍处于父级的层叠上下文中                                 |
  | `z-index: 0`    | **会创建**层叠上下文（前提是元素是定位元素） | `position` 为 `relative`、`absolute`、`fixed` 或 `sticky` 时生效 |



## 层叠准则

知道了前面这些，我们还需要掌握：当多个元素发生重叠时，**到底谁在上，谁在下**？

其实只需要遵循这套**判断准则**就可以判断，为此我画了一张流程图：

![image-20250528080659574](images/image-20250528080659574.png)

**⚠️ 注意：**

- 元素的层叠顺序可以**参考前面的 “层叠顺序图”**，谁的层叠顺序高，谁就显示在上方
- 如果你发现调整 `z-index` 无效，极有可能是因为你正试图比较**不在同一层叠上下文**的元素
